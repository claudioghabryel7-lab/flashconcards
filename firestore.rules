  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      
      function isAuthenticated() {
        return request.auth != null;
      }
      
      function isOwner(userId) {
        return isAuthenticated() && request.auth.uid == userId;
      }
      
      function isAdmin() {
        return isAuthenticated() && 
              exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /users/{userId} {
        // Permitir leitura para todos autenticados (para ranking) - apenas campos p√∫blicos
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && (
          (isOwner(userId) && 
          (request.resource.data.role == resource.data.role ||
            !resource.data.hasAny(['role']))) ||
          isAdmin()
        );
        allow delete: if isAdmin();
      }
      
      match /flashcards/{cardId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
      
      match /progress/{progressId} {
        // Permitir leitura para todos autenticados (para ranking)
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
        allow delete: if isAdmin();
      }
      
      match /userProgress/{userId} {
        // Permitir leitura para todos autenticados (para ranking)
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && userId == request.auth.uid;
        allow delete: if isAdmin();
      }
      
      match /chats/{userId}/messages/{messageId} {
        allow read: if isAuthenticated() && (userId == request.auth.uid || isAdmin());
        allow create: if isAuthenticated() && userId == request.auth.uid;
        allow update: if false;
        allow delete: if isAdmin();
      }
      
      match /config/{configId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
      
      match /homeBanners/{bannerId} {
        // Permitir leitura p√∫blica (sem autentica√ß√£o) para banners na p√°gina inicial
        allow read: if true;
        // Admin pode criar, atualizar e deletar - VERIFICA√á√ÉO EXPANDIDA
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /reviews/{reviewId} {
        // Leitura p√∫blica de todas as avalia√ß√µes (filtro de aprovadas √© feito no c√≥digo)
        allow read: if true;
        // Usu√°rios autenticados podem criar avalia√ß√µes
        allow create: if isAuthenticated();
        // Apenas admin pode atualizar ou deletar
        allow update, delete: if isAuthenticated() && 
                                exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // ‚úÖ CORRIGIDO: Regra expandida diretamente para deletedUsers
      match /deletedUsers/{userId} {
        // Admin pode ler
        allow read: if isAuthenticated() && 
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        // Admin pode criar - VERIFICA√á√ÉO EXPANDIDA
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        allow update, delete: if false;
      }
      
      match /questoesStats/{userId} {
        allow read: if isAuthenticated() && (userId == request.auth.uid || isAdmin());
        allow create, update: if isAuthenticated() && userId == request.auth.uid;
        allow delete: if isAdmin();
      }
      
      match /presence/{userId} {
        allow read, create, update: if isAuthenticated() && isOwner(userId);
        allow read: if isAdmin();
        allow delete: if false;
      }
      
      match /passwordResetTokens/{tokenId} {
        // Apenas admin pode criar tokens
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Leitura p√∫blica do token (para validar na p√°gina de reset)
        allow read: if true;
        // Apenas admin pode atualizar ou deletar
        allow update, delete: if isAuthenticated() && 
                                exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // üî• NOVO: Cache de Quest√µes (compartilhado entre alunos)
      match /questoesCache/{cacheId} {
        // Todos autenticados podem ler (para usar quest√µes do cache)
        allow read: if isAuthenticated();
        // Apenas sistema pode criar/atualizar (via c√≥digo)
        allow create, update: if isAuthenticated();
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üî• NOVO: Cache de Explica√ß√µes (compartilhado entre alunos)
      match /explanationsCache/{explanationId} {
        // Todos autenticados podem ler (para usar explica√ß√µes do cache)
        allow read: if isAuthenticated();
        // Apenas sistema pode criar/atualizar (via c√≥digo)
        allow create, update: if isAuthenticated();
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üí≥ Transa√ß√µes de Pagamento
      match /transactions/{transactionId} {
        // Permitir cria√ß√£o de transa√ß√µes por qualquer pessoa (checkout p√∫blico)
        // Isso permite que usu√°rios n√£o autenticados iniciem o processo de pagamento
        allow create: if true;
        
        // Usu√°rios autenticados podem ler suas pr√≥prias transa√ß√µes
        allow read: if isAuthenticated() && 
                      (resource.data.userEmail == request.auth.token.email ||
                       resource.data.userId == request.auth.uid ||
                       isAdmin());
        
        // Apenas admin pode atualizar transa√ß√µes (para mudar status de pagamento)
        allow update: if isAdmin();
        
        // Apenas admin pode deletar
        allow delete: if isAdmin();
      }
      
      match /{document=**} {
        allow read, write: if false;
      }
    }
  }

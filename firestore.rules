  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      
      function isAuthenticated() {
        return request.auth != null;
      }
      
      function isOwner(userId) {
        return isAuthenticated() && request.auth.uid == userId;
      }
      
      function isAdmin() {
        return isAuthenticated() && 
              exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /users/{userId} {
        // Permitir leitura para todos autenticados (para ranking) - apenas campos p√∫blicos
        // Tamb√©m permitir leitura do pr√≥prio perfil mesmo se n√£o estiver completamente autenticado
        allow read: if isAuthenticated() || (request.auth != null && request.auth.uid == userId);
        allow create: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && (
          (isOwner(userId) && 
          (request.resource.data.role == resource.data.role ||
            !resource.data.hasAny(['role']))) ||
          isAdmin()
        );
        allow delete: if isAdmin();
      }
      
      match /flashcards/{cardId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
      
      match /progress/{progressId} {
        // Permitir leitura para todos autenticados (para ranking)
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
        allow delete: if isAdmin();
      }
      
      match /userProgress/{userId} {
        // Permitir leitura para todos autenticados (para ranking)
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && userId == request.auth.uid;
        allow delete: if isAdmin();
      }
      
      match /chats/{userId}/messages/{messageId} {
        allow read: if isAuthenticated() && (userId == request.auth.uid || isAdmin());
        allow create: if isAuthenticated() && userId == request.auth.uid;
        allow update: if false;
        allow delete: if isAdmin();
      }
      
      match /config/{configId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
      
      // üîî Popup Banner (configura√ß√£o especial)
      match /config/popupBanner {
        // Permitir leitura p√∫blica (para mostrar popup na p√°gina inicial)
        allow read: if true;
        // Admin pode criar, atualizar e deletar
        allow create, update, delete: if isAuthenticated() && 
                                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /homeBanners/{bannerId} {
        // Permitir leitura p√∫blica (sem autentica√ß√£o) para banners na p√°gina inicial
        allow read: if true;
        // Admin pode criar, atualizar e deletar - VERIFICA√á√ÉO EXPANDIDA
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      
      // üéì Cursos Preparat√≥rios
      match /courses/{courseId} {
        // Permitir leitura p√∫blica de cursos ativos (para p√°gina inicial)
        allow read: if true;
        // Admin pode criar, atualizar e deletar
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        // Mat√©rias do curso (subcole√ß√£o)
        match /subjects/{subjectId} {
          allow read: if isAuthenticated();
          allow create, update, delete: if isAuthenticated() && 
                                          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Prompts do curso (subcole√ß√£o) - edital e quest√µes
        match /prompts/{promptId} {
          // Permitir leitura p√∫blica (para gerar quest√µes de simulados compartilhados)
          allow read: if true;
          // Apenas admin pode criar, atualizar e deletar - VERIFICA√á√ÉO EXPANDIDA
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Configura√ß√µes do curso (subcole√ß√£o) - ordem de mat√©rias e m√≥dulos
        match /config/{configId} {
          // Permitir leitura para usu√°rios autenticados
          allow read: if isAuthenticated();
          // Apenas admin pode criar, atualizar e deletar
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Edital Verticalizado (subcole√ß√£o)
        match /editalVerticalizado/{docId} {
          // Permitir leitura para usu√°rios autenticados
          allow read: if isAuthenticated();
          // Apenas admin pode criar e deletar
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          // Permitir que usu√°rios autenticados atualizem (para marcar checkboxes dia, horas, revisoes)
          // Admin pode atualizar tudo
          allow update: if isAuthenticated();
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Mat√©rias Revisadas (subcole√ß√£o)
        match /materiasRevisadas/{docId} {
          // Permitir leitura para usu√°rios autenticados
          allow read: if isAuthenticated();
          // Apenas admin pode criar, atualizar e deletar
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Conte√∫dos Completos (subcole√ß√£o)
        match /conteudosCompletos/{docId} {
          // Permitir leitura para usu√°rios autenticados
          allow read: if isAuthenticated();
          // Apenas admin pode criar, atualizar e deletar
          allow create, update, delete: if isAdmin();
        }
      }
      
      match /reviews/{reviewId} {
        // Leitura p√∫blica de todas as avalia√ß√µes (filtro de aprovadas √© feito no c√≥digo)
        allow read: if true;
        // Usu√°rios autenticados podem criar avalia√ß√µes
        allow create: if isAuthenticated();
        // Apenas admin pode atualizar ou deletar
        allow update, delete: if isAuthenticated() && 
                                exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // ‚úÖ CORRIGIDO: Regra expandida diretamente para deletedUsers
      match /deletedUsers/{userId} {
        // Admin pode ler
        allow read: if isAuthenticated() && 
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        // Admin pode criar - VERIFICA√á√ÉO EXPANDIDA
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        allow update, delete: if false;
      }
      
      match /questoesStats/{docId} {
        // O docId pode ser apenas userId ou userId_courseKey
        // Verificar se come√ßa com o uid do usu√°rio autenticado
        function isOwnerDoc() {
          return isAuthenticated() && 
                 (docId == request.auth.uid || 
                  docId.matches('^' + request.auth.uid + '_.*'));
        }
        
        allow read: if isAuthenticated() && (isOwnerDoc() || isAdmin());
        allow create, update: if isAuthenticated() && isOwnerDoc();
        allow delete: if isAdmin();
      }
      
      match /presence/{userId} {
        allow read, create, update: if isAuthenticated() && isOwner(userId);
        allow read: if isAdmin();
        allow delete: if false;
      }
      
      // üéÅ Testes Gratuitos
      match /testTrials/{trialId} {
        // Leitura p√∫blica (para validar token)
        allow read: if true;
        // Admin pode criar e deletar
        allow create, delete: if isAdmin();
        // Admin pode atualizar tudo, usu√°rios autenticados podem atualizar apenas registeredUsers
        allow update: if isAdmin() || 
                      (isAuthenticated() && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['registeredUsers', 'accessCount', 'lastAccessedAt']));
      }
      
      match /passwordResetTokens/{tokenId} {
        // Apenas admin pode criar tokens
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Leitura p√∫blica do token (para validar na p√°gina de reset)
        allow read: if true;
        // Apenas admin pode atualizar ou deletar
        allow update, delete: if isAuthenticated() && 
                                exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // üî• NOVO: Cache de Quest√µes (compartilhado entre alunos)
      match /questoesCache/{cacheId} {
        // Todos autenticados podem ler (para usar quest√µes do cache)
        allow read: if isAuthenticated();
        // Usu√°rios autenticados podem criar/atualizar (sistema cria cache automaticamente)
        // Valida√ß√£o: deve ter estrutura correta (questoes, materia, modulo)
        allow create: if isAuthenticated() && 
                       request.resource.data.keys().hasAll(['questoes', 'materia', 'modulo']) &&
                       request.resource.data.questoes is list &&
                       request.resource.data.likes is int &&
                       request.resource.data.dislikes is int;
        allow update: if isAuthenticated() && 
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes', 'updatedAt']) ||
                        isAdmin());
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üî• NOVO: Cache de Explica√ß√µes (compartilhado entre alunos)
      match /explanationsCache/{explanationId} {
        // Todos autenticados podem ler (para usar explica√ß√µes do cache)
        allow read: if isAuthenticated();
        // Usu√°rios autenticados podem criar (sistema cria cache automaticamente)
        // Valida√ß√£o: deve ter estrutura correta (text)
        allow create: if isAuthenticated() && 
                       request.resource.data.keys().hasAll(['text']) &&
                       request.resource.data.text is string &&
                       request.resource.data.likes is int &&
                       request.resource.data.dislikes is int;
        // Apenas atualiza√ß√£o de likes/dislikes ou admin pode atualizar tudo
        allow update: if isAuthenticated() && 
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes', 'updatedAt']) ||
                        isAdmin());
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üî• NOVO: Cache de Mapas Mentais (compartilhado entre alunos)
      match /mindMapsCache/{cacheId} {
        // Todos autenticados podem ler (para usar mapas do cache)
        allow read: if isAuthenticated();
        // Usu√°rios autenticados podem criar (sistema cria cache automaticamente)
        // Valida√ß√£o: deve ter estrutura correta (structure, materia, modulo)
        allow create: if isAuthenticated() && 
                       request.resource.data.keys().hasAll(['materia', 'modulo']) &&
                       request.resource.data.likes is int &&
                       request.resource.data.dislikes is int;
        // Apenas atualiza√ß√£o de likes/dislikes ou admin pode atualizar tudo
        allow update: if isAuthenticated() && 
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes', 'updatedAt']) ||
                        isAdmin());
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üí≥ Transa√ß√µes de Pagamento
      match /transactions/{transactionId} {
        // Permitir cria√ß√£o de transa√ß√µes por qualquer pessoa (checkout p√∫blico)
        // Isso permite que usu√°rios n√£o autenticados iniciem o processo de pagamento
        allow create: if true;
        
        // Permitir leitura de transa√ß√µes:
        // - Dono da transa√ß√£o (por userId ou email) pode ler
        // - Admin pode ler todas
        // - Leitura p√∫blica apenas se for a pr√≥pria transa√ß√£o (para verificar status ap√≥s cria√ß√£o sem login)
        //   usando transactionId como valida√ß√£o
        allow read: if isAuthenticated() && (
          (resource != null && resource.data != null && (
            resource.data.userId == request.auth.uid ||
            resource.data.userEmail == request.auth.token.email
          )) ||
          isAdmin()
        ) || (
          !isAuthenticated() && 
          resource != null && 
          resource.data != null &&
          resource.data.transactionId == transactionId
        );
        
        // Permitir atualiza√ß√£o:
        // - Apenas dono da transa√ß√£o (por userId ou email) ou admin
        // - Fun√ß√µes Firebase usam Admin SDK e bypassam essas regras automaticamente
        allow update: if isAuthenticated() && (
          (resource != null && resource.data != null && (
            resource.data.userId == request.auth.uid ||
            resource.data.userEmail == request.auth.token.email
          )) ||
          isAdmin()
        );
        
        // Apenas admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üì± Feed Social - Posts
      match /posts/{postId} {
        // Permitir leitura p√∫blica de not√≠cias, ou posts para autenticados
        // Esta regra permite que qualquer pessoa leia posts marcados como not√≠cia
        // e usu√°rios autenticados podem ler todos os posts
        // Verificar se resource.data existe antes de acessar propriedades
        allow read: if (resource != null && resource.data != null && resource.data.isNews == true) || isAuthenticated();
        
        // Usu√°rios autenticados podem criar posts
        allow create: if isAuthenticated() && 
                       request.resource.data.authorId == request.auth.uid &&
                       (request.resource.data.isNews == null || isAdmin());
        
        // Atualiza√ß√µes: qualquer usu√°rio autenticado pode atualizar posts
        // Isso permite curtir, comentar e compartilhar
        // Protegendo apenas o authorId para n√£o permitir mudan√ßa de autor
        // Admin pode marcar/desmarcar como not√≠cia
        allow update: if isAuthenticated() && 
                       request.resource.data.authorId == resource.data.authorId &&
                       (request.resource.data.isNews == resource.data.isNews || isAdmin());
        
        // Apenas o autor ou admin pode deletar
        allow delete: if isAuthenticated() && 
                       (resource.data.authorId == request.auth.uid || isAdmin());
      }
      
      // üì∏ Stories - FlashSocial
      match /stories/{storyId} {
        // Todos autenticados podem ler stories n√£o expiradas
        allow read: if isAuthenticated();
        
        // Usu√°rios autenticados podem criar suas pr√≥prias stories
        allow create: if isAuthenticated() && 
                       request.resource.data.authorId == request.auth.uid;
        
        // Apenas o autor pode deletar sua pr√≥pria story
        allow delete: if isAuthenticated() && 
                       (resource.data.authorId == request.auth.uid || isAdmin());
        // Stories n√£o podem ser atualizadas (s√≥ criadas/deletadas)
        allow update: if false;
      }
      
      // üìù Simulados Compartilhados
      match /sharedSimulados/{simuladoId} {
        // Leitura p√∫blica (para acessar simulado compartilhado)
        allow read: if true;
        // Apenas admin pode criar (compartilhar)
        allow create: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Admin pode atualizar tudo
        // Usu√°rios autenticados podem atualizar apenas 'attempts' e 'questions' 
        // (para registrar tentativas de simulado compartilhado)
        // Nota: Esta regra permite que qualquer autenticado atualize, o que pode ser um risco
        // Se necess√°rio, adicionar valida√ß√£o de token de acesso ou limita√ß√£o por IP
        allow update: if (isAuthenticated() && 
                          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
                     || 
                     (isAuthenticated() &&
                      resource != null &&
                      resource.data != null &&
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attempts']) ||
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['questions']) ||
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attempts', 'questions'])));
        // Apenas admin pode deletar
        allow delete: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // üìã Leads de Simulados
      match /leads/{leadId} {
        // Apenas admin pode ler leads
        allow read: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Qualquer pessoa pode criar lead (formul√°rio p√∫blico)
        allow create: if true;
        // Apenas admin pode atualizar (marcar como contatado, adicionar notas)
        allow update: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Apenas admin pode deletar
        allow delete: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /{document=**} {
        allow read, write: if false;
      }
    }
  }
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      
      function isAuthenticated() {
        return request.auth != null;
      }
      
      function isOwner(userId) {
        return isAuthenticated() && request.auth.uid == userId;
      }
      
      function isAdmin() {
        return isAuthenticated() && 
              exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /users/{userId} {
        // Permitir leitura para todos autenticados (para ranking) - apenas campos p√∫blicos
        // Tamb√©m permitir leitura do pr√≥prio perfil mesmo se n√£o estiver completamente autenticado
        allow read: if isAuthenticated() || (request.auth != null && request.auth.uid == userId);
        allow create: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && (
          (isOwner(userId) && 
          (request.resource.data.role == resource.data.role ||
            !resource.data.hasAny(['role']))) ||
          isAdmin()
        );
        allow delete: if isAdmin();
      }
      
      match /flashcards/{cardId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
      
      match /progress/{progressId} {
        // Permitir leitura para todos autenticados (para ranking)
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
        allow delete: if isAdmin();
      }
      
      match /userProgress/{userId} {
        // Permitir leitura para todos autenticados (para ranking)
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && userId == request.auth.uid;
        allow delete: if isAdmin();
      }
      
      match /chats/{userId}/messages/{messageId} {
        allow read: if isAuthenticated() && (userId == request.auth.uid || isAdmin());
        allow create: if isAuthenticated() && userId == request.auth.uid;
        allow update: if false;
        allow delete: if isAdmin();
      }
      
      match /config/{configId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
      
      // üîî Popup Banner (configura√ß√£o especial)
      match /config/popupBanner {
        // Permitir leitura p√∫blica (para mostrar popup na p√°gina inicial)
        allow read: if true;
        // Admin pode criar, atualizar e deletar
        allow create, update, delete: if isAuthenticated() && 
                                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /homeBanners/{bannerId} {
        // Permitir leitura p√∫blica (sem autentica√ß√£o) para banners na p√°gina inicial
        allow read: if true;
        // Admin pode criar, atualizar e deletar - VERIFICA√á√ÉO EXPANDIDA
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // üéì Cursos Preparat√≥rios
      match /courses/{courseId} {
        // Permitir leitura p√∫blica de cursos ativos (para p√°gina inicial)
        allow read: if true;
        // Admin pode criar, atualizar e deletar
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        // Mat√©rias do curso (subcole√ß√£o)
        match /subjects/{subjectId} {
          allow read: if isAuthenticated();
          allow create, update, delete: if isAuthenticated() && 
                                          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Prompts do curso (subcole√ß√£o) - edital e quest√µes
        match /prompts/{promptId} {
          // Permitir leitura p√∫blica (para gerar quest√µes de simulados compartilhados)
          allow read: if true;
          // Apenas admin pode criar, atualizar e deletar - VERIFICA√á√ÉO EXPANDIDA
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Configura√ß√µes do curso (subcole√ß√£o) - ordem de mat√©rias e m√≥dulos
        match /config/{configId} {
          // Permitir leitura para usu√°rios autenticados
          allow read: if isAuthenticated();
          // Apenas admin pode criar, atualizar e deletar
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
      }
      
      match /reviews/{reviewId} {
        // Leitura p√∫blica de todas as avalia√ß√µes (filtro de aprovadas √© feito no c√≥digo)
        allow read: if true;
        // Usu√°rios autenticados podem criar avalia√ß√µes
        allow create: if isAuthenticated();
        // Apenas admin pode atualizar ou deletar
        allow update, delete: if isAuthenticated() && 
                                exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // ‚úÖ CORRIGIDO: Regra expandida diretamente para deletedUsers
      match /deletedUsers/{userId} {
        // Admin pode ler
        allow read: if isAuthenticated() && 
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        // Admin pode criar - VERIFICA√á√ÉO EXPANDIDA
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        allow update, delete: if false;
      }
      
      match /questoesStats/{docId} {
        // O docId pode ser apenas userId ou userId_courseKey
        // Verificar se come√ßa com o uid do usu√°rio autenticado
        function isOwnerDoc() {
          return isAuthenticated() && 
                 (docId == request.auth.uid || 
                  docId.matches('^' + request.auth.uid + '_.*'));
        }
        
        allow read: if isAuthenticated() && (isOwnerDoc() || isAdmin());
        allow create, update: if isAuthenticated() && isOwnerDoc();
        allow delete: if isAdmin();
      }
      
      match /presence/{userId} {
        allow read, create, update: if isAuthenticated() && isOwner(userId);
        allow read: if isAdmin();
        allow delete: if false;
      }
      
      match /passwordResetTokens/{tokenId} {
        // Apenas admin pode criar tokens
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Leitura p√∫blica do token (para validar na p√°gina de reset)
        allow read: if true;
        // Apenas admin pode atualizar ou deletar
        allow update, delete: if isAuthenticated() && 
                                exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // üî• NOVO: Cache de Quest√µes (compartilhado entre alunos)
      match /questoesCache/{cacheId} {
        // Todos autenticados podem ler (para usar quest√µes do cache)
        allow read: if isAuthenticated();
        // Apenas sistema pode criar/atualizar (via c√≥digo)
        allow create, update: if isAuthenticated();
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üî• NOVO: Cache de Explica√ß√µes (compartilhado entre alunos)
      match /explanationsCache/{explanationId} {
        // Todos autenticados podem ler (para usar explica√ß√µes do cache)
        allow read: if isAuthenticated();
        // Apenas sistema pode criar/atualizar (via c√≥digo)
        allow create, update: if isAuthenticated();
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üî• NOVO: Cache de Mapas Mentais (compartilhado entre alunos)
      match /mindMapsCache/{cacheId} {
        // Todos autenticados podem ler (para usar mapas do cache)
        allow read: if isAuthenticated();
        // Apenas sistema pode criar/atualizar (via c√≥digo)
        allow create, update: if isAuthenticated();
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üí≥ Transa√ß√µes de Pagamento
      match /transactions/{transactionId} {
        // Permitir cria√ß√£o de transa√ß√µes por qualquer pessoa (checkout p√∫blico)
        // Isso permite que usu√°rios n√£o autenticados iniciem o processo de pagamento
        allow create: if true;
        
        // Permitir leitura de transa√ß√µes:
        // - Permitir leitura p√∫blica (para verificar status ap√≥s cria√ß√£o sem login)
        // Nota: Em produ√ß√£o, voc√™ pode restringir mais se necess√°rio
        allow read: if true;
        
        // Permitir atualiza√ß√£o:
        // - Qualquer pessoa pode atualizar (para adicionar dados do PIX ap√≥s cria√ß√£o)
        // - Mas apenas campos relacionados ao pagamento
        // Nota: Fun√ß√µes Firebase usam Admin SDK e bypassam essas regras automaticamente
        // Em produ√ß√£o, voc√™ pode adicionar verifica√ß√£o por token ou email
        allow update: if true;
        
        // Apenas admin pode deletar
        allow delete: if isAdmin();
      }
      
      // üì± Feed Social - Posts
      match /posts/{postId} {
        // Permitir leitura p√∫blica de not√≠cias, ou posts para autenticados
        // Esta regra permite que qualquer pessoa leia posts marcados como not√≠cia
        // e usu√°rios autenticados podem ler todos os posts
        allow read: if resource.data.isNews == true || isAuthenticated();
        
        // Usu√°rios autenticados podem criar posts
        allow create: if isAuthenticated() && 
                       request.resource.data.authorId == request.auth.uid &&
                       (request.resource.data.isNews == null || isAdmin());
        
        // Atualiza√ß√µes: qualquer usu√°rio autenticado pode atualizar posts
        // Isso permite curtir, comentar e compartilhar
        // Protegendo apenas o authorId para n√£o permitir mudan√ßa de autor
        // Admin pode marcar/desmarcar como not√≠cia
        allow update: if isAuthenticated() && 
                       request.resource.data.authorId == resource.data.authorId &&
                       (request.resource.data.isNews == resource.data.isNews || isAdmin());
        
        // Apenas o autor ou admin pode deletar
        allow delete: if isAuthenticated() && 
                       (resource.data.authorId == request.auth.uid || isAdmin());
      }
      
      // üì∏ Stories - FlashSocial
      match /stories/{storyId} {
        // Todos autenticados podem ler stories n√£o expiradas
        allow read: if isAuthenticated();
        
        // Usu√°rios autenticados podem criar suas pr√≥prias stories
        allow create: if isAuthenticated() && 
                       request.resource.data.authorId == request.auth.uid;
        
        // Apenas o autor pode deletar sua pr√≥pria story
        allow delete: if isAuthenticated() && 
                       (resource.data.authorId == request.auth.uid || isAdmin());
        // Stories n√£o podem ser atualizadas (s√≥ criadas/deletadas)
        allow update: if false;
      }
      
      // üìù Simulados Compartilhados
      match /sharedSimulados/{simuladoId} {
        // Leitura p√∫blica (para acessar simulado compartilhado)
        allow read: if true;
        // Apenas admin pode criar (compartilhar)
        allow create: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Admin pode atualizar OU qualquer pessoa pode atualizar apenas 'attempts' e 'questions'
        allow update: if (isAuthenticated() && 
                          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
                     || 
                     (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attempts']) ||
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['questions']) ||
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attempts', 'questions']));
        // Apenas admin pode deletar
        allow delete: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // üìã Leads de Simulados
      match /leads/{leadId} {
        // Apenas admin pode ler leads
        allow read: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Qualquer pessoa pode criar lead (formul√°rio p√∫blico)
        allow create: if true;
        // Apenas admin pode atualizar (marcar como contatado, adicionar notas)
        allow update: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Apenas admin pode deletar
        allow delete: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /{document=**} {
        allow read, write: if false;
      }
    }
  }
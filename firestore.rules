  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      
      function isAuthenticated() {
        return request.auth != null;
      }
      
      function isOwner(userId) {
        return isAuthenticated() && request.auth.uid == userId;
      }
      
      function isAdmin() {
        return isAuthenticated() && 
              exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /users/{userId} {
        // Permitir leitura para todos autenticados (para ranking) - apenas campos pﾃｺblicos
        // Tambﾃｩm permitir leitura do prﾃｳprio perfil mesmo se nﾃ｣o estiver completamente autenticado
        allow read: if isAuthenticated() || (request.auth != null && request.auth.uid == userId);
        allow create: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && (
          (isOwner(userId) && 
          (request.resource.data.role == resource.data.role ||
            !resource.data.hasAny(['role']))) ||
          isAdmin()
        );
        allow delete: if isAdmin();
      }
      
      match /flashcards/{cardId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
      
      match /progress/{progressId} {
        // Permitir leitura para todos autenticados (para ranking)
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
        allow delete: if isAdmin();
      }
      
      match /userProgress/{userId} {
        // Permitir leitura para todos autenticados (para ranking)
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && userId == request.auth.uid;
        allow delete: if isAdmin();
      }
      
      match /chats/{userId}/messages/{messageId} {
        allow read: if isAuthenticated() && (userId == request.auth.uid || isAdmin());
        allow create: if isAuthenticated() && userId == request.auth.uid;
        allow update: if false;
        allow delete: if isAdmin();
      }
      
      match /config/{configId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin();
      }
      
      // 粕 Popup Banner (configuraﾃｧﾃ｣o especial)
      match /config/popupBanner {
        // Permitir leitura pﾃｺblica (para mostrar popup na pﾃ｡gina inicial)
        allow read: if true;
        // Admin pode criar, atualizar e deletar
        allow create, update, delete: if isAuthenticated() && 
                                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /homeBanners/{bannerId} {
        // Permitir leitura pﾃｺblica (sem autenticaﾃｧﾃ｣o) para banners na pﾃ｡gina inicial
        allow read: if true;
        // Admin pode criar, atualizar e deletar - VERIFICAﾃﾃグ EXPANDIDA
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // 櫨 Marketing Hero (Seﾃｧﾃ｣o Persuasiva Final)
      match /marketingHero/{heroId} {
        // Permitir leitura pﾃｺblica (sem autenticaﾃｧﾃ｣o) para aparecer na pﾃ｡gina inicial
        allow read: if true;
        // Admin pode criar, atualizar e deletar - VERIFICAﾃﾃグ EXPANDIDA
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // 雌 Cursos Preparatﾃｳrios
      match /courses/{courseId} {
        // Permitir leitura pﾃｺblica de cursos ativos (para pﾃ｡gina inicial)
        allow read: if true;
        // Admin pode criar, atualizar e deletar
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        // Matﾃｩrias do curso (subcoleﾃｧﾃ｣o)
        match /subjects/{subjectId} {
          allow read: if isAuthenticated();
          allow create, update, delete: if isAuthenticated() && 
                                          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Prompts do curso (subcoleﾃｧﾃ｣o) - edital e questﾃｵes
        match /prompts/{promptId} {
          // Permitir leitura pﾃｺblica (para gerar questﾃｵes de simulados compartilhados)
          allow read: if true;
          // Apenas admin pode criar, atualizar e deletar - VERIFICAﾃﾃグ EXPANDIDA
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Configuraﾃｧﾃｵes do curso (subcoleﾃｧﾃ｣o) - ordem de matﾃｩrias e mﾃｳdulos
        match /config/{configId} {
          // Permitir leitura para usuﾃ｡rios autenticados
          allow read: if isAuthenticated();
          // Apenas admin pode criar, atualizar e deletar
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Edital Verticalizado (subcoleﾃｧﾃ｣o)
        match /editalVerticalizado/{docId} {
          // Permitir leitura para usuﾃ｡rios autenticados
          allow read: if isAuthenticated();
          // Apenas admin pode criar e deletar
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          // Permitir que usuﾃ｡rios autenticados atualizem (para marcar checkboxes dia, horas, revisoes)
          // Admin pode atualizar tudo
          allow update: if isAuthenticated();
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Matﾃｩrias Revisadas (subcoleﾃｧﾃ｣o)
        match /materiasRevisadas/{docId} {
          // Permitir leitura para usuﾃ｡rios autenticados
          allow read: if isAuthenticated();
          // Apenas admin pode criar, atualizar e deletar
          allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow update: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
          allow delete: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        }
        
        // Conteﾃｺdos Completos (subcoleﾃｧﾃ｣o)
        match /conteudosCompletos/{docId} {
          // Permitir leitura para usuﾃ｡rios autenticados
          allow read: if isAuthenticated();
          // Apenas admin pode criar, atualizar e deletar
          allow create, update, delete: if isAdmin();
        }
      }
      
      match /reviews/{reviewId} {
        // Leitura pﾃｺblica de todas as avaliaﾃｧﾃｵes (filtro de aprovadas ﾃｩ feito no cﾃｳdigo)
        allow read: if true;
        // Usuﾃ｡rios autenticados podem criar avaliaﾃｧﾃｵes
        allow create: if isAuthenticated();
        // Apenas admin pode atualizar ou deletar
        allow update, delete: if isAuthenticated() && 
                                exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // 笨 CORRIGIDO: Regra expandida diretamente para deletedUsers
      match /deletedUsers/{userId} {
        // Admin pode ler
        allow read: if isAuthenticated() && 
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        // Admin pode criar - VERIFICAﾃﾃグ EXPANDIDA
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        allow update, delete: if false;
      }
      
      match /questoesStats/{docId} {
        // O docId pode ser apenas userId ou userId_courseKey
        // Verificar se comeﾃｧa com o uid do usuﾃ｡rio autenticado
        function isOwnerDoc() {
          return isAuthenticated() && 
                 (docId == request.auth.uid || 
                  docId.matches('^' + request.auth.uid + '_.*'));
        }
        
        allow read: if isAuthenticated() && (isOwnerDoc() || isAdmin());
        allow create, update: if isAuthenticated() && isOwnerDoc();
        allow delete: if isAdmin();
      }
      
      match /presence/{userId} {
        allow read, create, update: if isAuthenticated() && isOwner(userId);
        allow read: if isAdmin();
        allow delete: if false;
      }
      
      // 氏 Testes Gratuitos
      match /testTrials/{trialId} {
        // Leitura pﾃｺblica (para validar token)
        allow read: if true;
        // Admin pode criar e deletar
        allow create, delete: if isAdmin();
        // Admin pode atualizar tudo, usuﾃ｡rios autenticados podem atualizar apenas registeredUsers
        allow update: if isAdmin() || 
                      (isAuthenticated() && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['registeredUsers', 'accessCount', 'lastAccessedAt']));
      }
      
      match /passwordResetTokens/{tokenId} {
        // Apenas admin pode criar tokens
        allow create: if isAuthenticated() && 
                        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Leitura pﾃｺblica do token (para validar na pﾃ｡gina de reset)
        allow read: if true;
        // Apenas admin pode atualizar ou deletar
        allow update, delete: if isAuthenticated() && 
                                exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                                get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // 櫨 NOVO: Cache de Questﾃｵes (compartilhado entre alunos)
      match /questoesCache/{cacheId} {
        // Todos autenticados podem ler (para usar questﾃｵes do cache)
        allow read: if isAuthenticated();
        // Usuﾃ｡rios autenticados podem criar/atualizar (sistema cria cache automaticamente)
        // Validaﾃｧﾃ｣o: deve ter estrutura correta (questoes, materia, modulo)
        allow create: if isAuthenticated() && 
                       request.resource.data.keys().hasAll(['questoes', 'materia', 'modulo']) &&
                       request.resource.data.questoes is list &&
                       request.resource.data.likes is int &&
                       request.resource.data.dislikes is int;
        allow update: if isAuthenticated() && 
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes', 'updatedAt']) ||
                        isAdmin());
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // 櫨 NOVO: Cache de Explicaﾃｧﾃｵes (compartilhado entre alunos)
      match /explanationsCache/{explanationId} {
        // Todos autenticados podem ler (para usar explicaﾃｧﾃｵes do cache)
        allow read: if isAuthenticated();
        // Usuﾃ｡rios autenticados podem criar (sistema cria cache automaticamente)
        // Validaﾃｧﾃ｣o: deve ter estrutura correta (text)
        allow create: if isAuthenticated() && 
                       request.resource.data.keys().hasAll(['text']) &&
                       request.resource.data.text is string &&
                       request.resource.data.likes is int &&
                       request.resource.data.dislikes is int;
        // Apenas atualizaﾃｧﾃ｣o de likes/dislikes ou admin pode atualizar tudo
        allow update: if isAuthenticated() && 
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes', 'updatedAt']) ||
                        isAdmin());
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // 櫨 NOVO: Cache de Mapas Mentais (compartilhado entre alunos)
      match /mindMapsCache/{cacheId} {
        // Todos autenticados podem ler (para usar mapas do cache)
        allow read: if isAuthenticated();
        // Usuﾃ｡rios autenticados podem criar (sistema cria cache automaticamente)
        // Validaﾃｧﾃ｣o: deve ter estrutura correta (structure, materia, modulo)
        allow create: if isAuthenticated() && 
                       request.resource.data.keys().hasAll(['materia', 'modulo']) &&
                       request.resource.data.likes is int &&
                       request.resource.data.dislikes is int;
        // Apenas atualizaﾃｧﾃ｣o de likes/dislikes ou admin pode atualizar tudo
        allow update: if isAuthenticated() && 
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'dislikes', 'updatedAt']) ||
                        isAdmin());
        // Admin pode deletar
        allow delete: if isAdmin();
      }
      
      // 諜 Transaﾃｧﾃｵes de Pagamento
      match /transactions/{transactionId} {
        // Permitir criaﾃｧﾃ｣o de transaﾃｧﾃｵes por qualquer pessoa (checkout pﾃｺblico)
        // Isso permite que usuﾃ｡rios nﾃ｣o autenticados iniciem o processo de pagamento
        allow create: if true;
        
        // Permitir leitura de transaﾃｧﾃｵes:
        // - Dono da transaﾃｧﾃ｣o (por userId ou email) pode ler
        // - Admin pode ler todas
        // - Leitura pﾃｺblica apenas se for a prﾃｳpria transaﾃｧﾃ｣o (para verificar status apﾃｳs criaﾃｧﾃ｣o sem login)
        //   usando transactionId como validaﾃｧﾃ｣o
        allow read: if isAuthenticated() && (
          (resource != null && resource.data != null && (
            resource.data.userId == request.auth.uid ||
            resource.data.userEmail == request.auth.token.email
          )) ||
          isAdmin()
        ) || (
          !isAuthenticated() && 
          resource != null && 
          resource.data != null &&
          resource.data.transactionId == transactionId
        );
        
        // Permitir atualizaﾃｧﾃ｣o:
        // - Apenas dono da transaﾃｧﾃ｣o (por userId ou email) ou admin
        // - Funﾃｧﾃｵes Firebase usam Admin SDK e bypassam essas regras automaticamente
        allow update: if isAuthenticated() && (
          (resource != null && resource.data != null && (
            resource.data.userId == request.auth.uid ||
            resource.data.userEmail == request.auth.token.email
          )) ||
          isAdmin()
        );
        
        // Apenas admin pode deletar
        allow delete: if isAdmin();
      }
      
      // 導 Feed Social - Posts
      match /posts/{postId} {
        // Permitir leitura pﾃｺblica de notﾃｭcias, ou posts para autenticados
        // Esta regra permite que qualquer pessoa leia posts marcados como notﾃｭcia
        // e usuﾃ｡rios autenticados podem ler todos os posts
        // Verificar se resource.data existe antes de acessar propriedades
        allow read: if (resource != null && resource.data != null && resource.data.isNews == true) || isAuthenticated();
        
        // Usuﾃ｡rios autenticados podem criar posts
        allow create: if isAuthenticated() && 
                       request.resource.data.authorId == request.auth.uid &&
                       (request.resource.data.isNews == null || isAdmin());
        
        // Atualizaﾃｧﾃｵes: qualquer usuﾃ｡rio autenticado pode atualizar posts
        // Isso permite curtir, comentar e compartilhar
        // Protegendo apenas o authorId para nﾃ｣o permitir mudanﾃｧa de autor
        // Admin pode marcar/desmarcar como notﾃｭcia
        allow update: if isAuthenticated() && 
                       request.resource.data.authorId == resource.data.authorId &&
                       (request.resource.data.isNews == resource.data.isNews || isAdmin());
        
        // Apenas o autor ou admin pode deletar
        allow delete: if isAuthenticated() && 
                       (resource.data.authorId == request.auth.uid || isAdmin());
      }
      
      // 萄 Stories - FlashSocial
      match /stories/{storyId} {
        // Todos autenticados podem ler stories nﾃ｣o expiradas
        allow read: if isAuthenticated();
        
        // Usuﾃ｡rios autenticados podem criar suas prﾃｳprias stories
        allow create: if isAuthenticated() && 
                       request.resource.data.authorId == request.auth.uid;
        
        // Apenas o autor pode deletar sua prﾃｳpria story
        allow delete: if isAuthenticated() && 
                       (resource.data.authorId == request.auth.uid || isAdmin());
        // Stories nﾃ｣o podem ser atualizadas (sﾃｳ criadas/deletadas)
        allow update: if false;
      }
      
      // 統 Simulados Compartilhados
      match /sharedSimulados/{simuladoId} {
        // Leitura pﾃｺblica (para acessar simulado compartilhado)
        allow read: if true;
        // Apenas admin pode criar (compartilhar)
        allow create: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Admin pode atualizar tudo
        // Usuﾃ｡rios autenticados podem atualizar apenas 'attempts' e 'questions' 
        // (para registrar tentativas de simulado compartilhado)
        // Nota: Esta regra permite que qualquer autenticado atualize, o que pode ser um risco
        // Se necessﾃ｡rio, adicionar validaﾃｧﾃ｣o de token de acesso ou limitaﾃｧﾃ｣o por IP
        allow update: if (isAuthenticated() && 
                          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
                     || 
                     (isAuthenticated() &&
                      resource != null &&
                      resource.data != null &&
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attempts']) ||
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['questions']) ||
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attempts', 'questions'])));
        // Apenas admin pode deletar
        allow delete: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // 搭 Leads de Simulados
      match /leads/{leadId} {
        // Apenas admin pode ler leads
        allow read: if isAuthenticated() && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Qualquer pessoa pode criar lead (formulﾃ｡rio pﾃｺblico)
        allow create: if true;
        // Apenas admin pode atualizar (marcar como contatado, adicionar notas)
        allow update: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        // Apenas admin pode deletar
        allow delete: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      match /{document=**} {
        allow read, write: if false;
      }
    }
  }